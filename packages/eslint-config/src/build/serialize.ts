import type { FlatConfigArray } from "../types"

/**
 * Serializes a flat config array to a JavaScript module string.
 * The output is a self-contained ES module that can be dynamically imported.
 */
export function serializeConfig(config: FlatConfigArray): string {
  const lines: string[] = [
    "// Auto-generated by @effective/eslint-config â€” do not edit",
    "// @ts-nocheck",
    `export default ${JSON.stringify(config, createReplacer(), 2)};`,
    "",
  ]

  return lines.join("\n")
}

/**
 * Serializes an OxLint config object to a JSON string.
 */
export function serializeOxlintConfig(config: unknown): string {
  return JSON.stringify(config, null, 2) + "\n"
}

function createReplacer(): (key: string, value: unknown) => unknown {
  const seen = new WeakSet()
  return function replacer(_key: string, value: unknown): unknown {
    if (typeof value === "function") {
      return `__FUNCTION__${value.toString()}`
    }
    if (value instanceof RegExp) {
      return `__REGEXP__${value.toString()}`
    }
    if (typeof value === "object" && value !== null) {
      if (seen.has(value)) {
        return undefined
      }
      seen.add(value)
    }
    return value
  }
}
